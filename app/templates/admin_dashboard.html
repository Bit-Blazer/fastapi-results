<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grade Changes Monitor - Admin Panel</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.ico" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>

  <body>
    <div class="admin-panel">
      <!-- Navigation header -->
      <div class="admin-header">
        <div class="admin-header-left">
          <h1>üõ°Ô∏è Admin Panel</h1>
        </div>
        <form method="post" action="/admin/logout/" class="admin-logout-form">
          <button type="submit" class="admin-logout-btn">üö™ Logout</button>
        </form>
      </div>

      <!-- Admin Navigation Menu -->
      <div class="admin-nav">
        <a
          href="#grade-changes"
          class="admin-nav-link active"
          onclick="showTab('grade-changes', this)"
        >
          üìä Grade Changes
        </a>
        <a
          href="#student-logs"
          class="admin-nav-link"
          onclick="showTab('student-logs', this)"
        >
          üë• Student Logs
        </a>
      </div>

      <!-- Grade Changes Tab Content -->
      <div id="grade-changes" class="tab-content active">
        <div class="card glass-card">
          <h1>üìä Grade Changes Monitor</h1>

          <div class="stats-cards">
            <div class="stat-card">
              <div class="stat-number" id="totalChanges">-</div>
              <div class="stat-label">Total Changes</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="todayChanges">-</div>
              <div class="stat-label">Today's Changes</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="activeStudents">-</div>
              <div class="stat-label">Students with Changes</div>
            </div>
          </div>

          <div class="search-section">
            <h3>Search Grade Changes</h3>
            <form onsubmit="event.preventDefault(); search();">
              <input
                type="text"
                id="regnoSearch"
                placeholder="üîç Enter registration number..."
                autofocus
              />
              <button type="submit">Search</button>
            </form>
          </div>

          <div id="loadingMessage" class="loading-centered hidden">
            Loading grade changes...
          </div>

          <div id="errorMessage" class="error-message hidden"></div>

          <div id="changesContainer">
            <div id="changesCount" class="changes-count"></div>
            <table class="changes-table hidden" id="changesTable">
              <thead>
                <tr>
                  <th>Reg No</th>
                  <th>Student Name</th>
                  <th>Subject</th>
                  <th>Semester</th>
                  <th>Grade Change</th>
                  <th>Credits</th>
                  <th>Changed At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="changesTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Student Logs Tab Content -->
      <div id="student-logs" class="tab-content">
        <div class="card glass-card">
          <h1>üë• Student Login Logs</h1>

          <div class="stats-cards student-logs-stats" id="student-stats">
            <div class="stat-card">
              <div class="stat-number" id="totalLogins">-</div>
              <div class="stat-label">Recent Logins</div>
            </div>

            <div class="stat-card">
              <div class="stat-number" id="uniqueStudents">-</div>
              <div class="stat-label">Unique Students</div>
            </div>
          </div>

          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Login Time</th>
                  <th>IP Address</th>
                  <th>Browser/Device</th>
                </tr>
              </thead>
              <tbody id="studentLogsTableBody">
                <!-- Student logs will be populated here -->
              </tbody>
            </table>
          </div>

          <div id="noStudentLogs" class="no-data-message hidden">
            <h3>No student login logs found</h3>
            <p>No student login activity has been recorded yet.</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentData = [];

      // Tab functionality
      function showTab(tabId, element) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll(".tab-content");
        tabContents.forEach((tab) => tab.classList.remove("active"));

        // Remove active class from all nav links
        const navLinks = document.querySelectorAll(".admin-nav-link");
        navLinks.forEach((link) => link.classList.remove("active"));

        // Show selected tab content
        document.getElementById(tabId).classList.add("active");

        // Add active class to clicked nav link
        if (element) {
          element.classList.add("active");
        }

        // Load student logs if switching to that tab
        if (tabId === "student-logs") {
          loadStudentLogs();
        }
      }

      // Load all grade changes on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Show grade changes tab by default
        const firstNavLink = document.querySelector(".admin-nav-link.active");
        if (firstNavLink) {
          showTab("grade-changes", firstNavLink);
        }

        refreshData();
      });

      // Function to search by registration number
      async function search() {
        const regno = document.getElementById("regnoSearch").value.trim();

        try {
          showLoading(true);
          hideError();

          const url = regno
            ? `/api/grade-changes/?regno=${encodeURIComponent(regno)}`
            : "/api/grade-changes/";
          const response = await fetch(url);
          const data = await response.json();

          if (data.success) {
            currentData = data.changes;
            displayChanges(data);
            updateStats(data);
            // Update count for search results
            document.getElementById(
              "changesCount"
            ).textContent = `Showing ${data.total_changes} change(s)`;
          } else {
            showError("Failed to load student grade changes: " + data.message);
          }
        } catch (error) {
          showError("Error searching grade changes: " + error.message);
        } finally {
          showLoading(false);
        }
      }

      // Function to display changes in table
      function displayChanges(data) {
        const tableBody = document.getElementById("changesTableBody");
        const table = document.getElementById("changesTable");
        const countDiv = document.getElementById("changesCount");

        // Clear existing data
        tableBody.innerHTML = "";

        if (currentData.length === 0) {
          countDiv.textContent = "No grade changes found";
          table.classList.add("hidden");
          return;
        }

        // Show table
        table.classList.remove("hidden");

        // Set count message
        if (data.student_name) {
          countDiv.textContent = `Showing ${currentData.length} change(s) for ${data.student_name}`;
        } else {
          countDiv.textContent = `Showing ${currentData.length} of ${data.total_changes} total changes`;
        } // Populate table
        currentData.forEach((change) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${change.regno}</td>
          <td>${change.student_name || "N/A"}</td>
          <td>${change.subject_code}</td>
          <td>${change.semester}</td>
          <td><span class="grade-change">${change.grade_difference}</span></td>
          <td>${change.credits}</td>
          <td><div class="timestamp">${formatDate(change.changed_at)}</div></td>
          <td>
            <button class="delete-btn" onclick="deleteGradeChange(${
              change.id
            })" title="Delete this grade change">
              ‚ùå
            </button>
          </td>
        `;
          tableBody.appendChild(row);
        });
      }

      // Function to update statistics
      function updateStats(data) {
        // Handle total changes - use API data if available, otherwise current data length
        const totalChanges = data.total_changes || currentData.length;
        document.getElementById("totalChanges").textContent = totalChanges;

        // Calculate today's changes
        const today = new Date().toDateString();
        const todayChanges = currentData.filter(
          (change) => new Date(change.changed_at).toDateString() === today
        ).length;
        document.getElementById("todayChanges").textContent = todayChanges;

        // Calculate unique students
        const uniqueStudents = new Set(
          currentData.map((change) => change.regno)
        ).size;
        document.getElementById("activeStudents").textContent = uniqueStudents;
      }

      // Function to delete a grade change
      async function deleteGradeChange(changeId) {
        try {
          const response = await fetch(`/api/grade-changes/${changeId}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (data.success) {
            // Show success message
            showNotification("Grade change deleted successfully ‚úÖ", "success");

            // Refresh the table
            refreshData();
          } else {
            showNotification(
              `Failed to delete grade change: ${data.message} ‚ùå`,
              "error"
            );
          }
        } catch (error) {
          console.error("Error deleting grade change:", error);
          showNotification("Error deleting grade change ‚ùå", "error");
        }
      }

      // Function to show notifications
      function showNotification(message, type) {
        // Remove existing notification if any
        const existingNotification = document.querySelector(
          ".admin-notification"
        );
        if (existingNotification) {
          existingNotification.remove();
        }

        // Create notification element
        const notification = document.createElement("div");
        notification.className = `admin-notification ${type}`;
        notification.textContent = message;

        document.body.appendChild(notification);

        // Auto remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = "slideIn 0.3s ease-out reverse";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      function refreshData() {
        const regno = document.getElementById("regnoSearch").value.trim();
        search(regno);
      }

      // Helper functions
      function showLoading(show) {
        const loadingElement = document.getElementById("loadingMessage");
        if (loadingElement) {
          if (show) {
            loadingElement.classList.remove("hidden");
          } else {
            loadingElement.classList.add("hidden");
          }
        }
      }

      function showError(message) {
        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.classList.remove("hidden");
        }
      }

      function hideError() {
        const errorElement = document.getElementById("errorMessage");
        if (errorElement) {
          errorElement.classList.add("hidden");
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("en-US", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
      }

      // Auto-refresh every 5 minutes
      setInterval(refreshData, 5 * 60 * 1000);

      // Student logs functionality
      async function loadStudentLogs() {
        try {
          const response = await fetch("/api/student-logs");
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          updateStudentStats(data.stats);
          populateStudentLogsTable(data.logs);
        } catch (error) {
          console.error("Error loading student logs:", error);
          showStudentLogsError(error.message);
        }
      }

      function updateStudentStats(stats) {
        document.getElementById("totalLogins").textContent =
          stats.total_logins || "0";
        document.getElementById("uniqueStudents").textContent =
          stats.unique_students || "0";
      }

      function populateStudentLogsTable(logs) {
        const tbody = document.getElementById("studentLogsTableBody");
        const noLogsDiv = document.getElementById("noStudentLogs");

        if (!logs || logs.length === 0) {
          tbody.innerHTML = "";
          noLogsDiv.classList.remove("hidden");
          return;
        }

        noLogsDiv.classList.add("hidden");
        tbody.innerHTML = logs
          .map(
            (log) => `
          <tr>
            <td>
              <div class="student-info">
                <div class="student-name">${log.name}</div>
                <div class="student-regno">${log.regno}</div>
              </div>
            </td>
            <td>
              <div class="datetime-cell">
                <div class="date">${formatDate(log.login_time)}</div>
                <div class="time">${formatTime(log.login_time)}</div>
              </div>
            </td>
            <td><span class="ip-address">${log.ip_address || "N/A"}</span></td>
            <td>
              <div class="user-agent">
                <span class="browser-info">${getBrowserInfo(
                  log.user_agent
                )}</span>
                <span class="device-type ${getDeviceType(
                  log.user_agent
                )}">${getDeviceType(log.user_agent)}</span>
              </div>
            </td>
          </tr>
        `
          )
          .join("");
      }

      function showStudentLogsError(message) {
        const tbody = document.getElementById("studentLogsTableBody");
        tbody.innerHTML = `<tr><td colspan="6" class="error-row">Error: ${message}</td></tr>`;
      }

      function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
        });
      }

      function formatTime(dateString) {
        return new Date(dateString).toLocaleTimeString("en-US", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
      }

      function getBrowserInfo(userAgent) {
        if (!userAgent) return "Unknown";

        if (userAgent.includes("Chrome")) return "üåê Chrome";
        if (userAgent.includes("Firefox")) return "ü¶ä Firefox";
        if (userAgent.includes("Safari")) return "üß≠ Safari";
        if (userAgent.includes("Edge")) return "üî∑ Edge";
        return "üåê Browser";
      }

      function getDeviceType(userAgent) {
        if (!userAgent) return "unknown";

        if (
          userAgent.includes("Mobile") ||
          userAgent.includes("Android") ||
          userAgent.includes("iPhone")
        ) {
          return "mobile";
        }
        return "desktop";
      }
    </script>
  </body>
</html>
